{"version":3,"file":"data-hub.min.js","sources":["../src/util/invariant.js","../src/store.js","../src/hub.js","../src/tool/vue.js","../src/middleware/log.js","../src/tool/react.js"],"sourcesContent":["let NODE_ENV = process.env.NODE_ENV;\n\nexport default function(condition, format, a, b, c, d, e, f) {\n  if (NODE_ENV !== 'production') {\n    if (format === undefined) {\n      throw new Error('invariant requires an error message argument');\n    }\n  }\n\n  if (!condition) {\n    let error;\n    if (format === undefined) {\n      error = new Error(\n        'Minified exception occurred; use the non-minified dev environment ' +\n        'for the full error message and additional helpful warnings.'\n      );\n    } else {\n      let args = [a, b, c, d, e, f];\n      let argIndex = 0;\n      error = new Error(\n        format.replace(/%s/g, function() { return args[argIndex++]; })\n      );\n      error.name = 'Invariant Violation';\n    }\n\n    error.framesToPop = 1; // we don't care about invariant's own frame\n    throw error;\n  }\n}\n","import {Subject} from './rxjs';\nimport invariant from './util/invariant';\n\nexport default class Store {\n\n  // constructor\n  constructor(options={}) {\n    this._check(options);\n\n    this.debug = !!options.debug;\n    this.name = options.name || 'data-hub store';\n    this._isRxHubStore = true;\n    this._subject = new Subject();\n    this._state = options.initialState || {};\n    this._mutations = options.mutations || {};\n    this._modules = options.modules || {};\n  }\n\n  _check(options) {\n    invariant(\n      typeof options === 'object',\n      `data-hub error ~ store: options is not an object!`\n    );\n\n    let initialState = options.initialState || {};\n    invariant(\n      initialState && typeof initialState === 'object',\n      `data-hub error ~ store: options.initialState is not an object!`\n    );\n\n    let mutations = options.mutations || {};\n    invariant(\n      mutations && typeof mutations === 'object',\n      `data-hub error ~ store: options.mutations is not an object!`\n    )\n\n    let modules = options.modules || {};\n    invariant(\n      modules && typeof modules === 'object',\n      `data-hub error ~ store: options.modules is not an object!`\n    );\n\n    Object.keys(modules).forEach(key => {\n      let module = modules[key];\n      invariant(\n        typeof module === 'object' && module._isRxHubStore,\n        `data-hub error ~ store: module must be a store instance!`\n      );\n    });\n  }\n\n  // subscribe\n  subscribe(...args) {\n    return this._subject.subscribe(...args);\n  }\n\n  // state\n  get state() {\n    return this.getState();\n  }\n\n  // get store's state\n  getState() {\n    let state = this._state;\n\n    Object.keys(this._modules).forEach(moduleName => {\n      state[moduleName] = this._modules[moduleName].getState();\n    });\n\n    return state;\n  }\n\n  /**\n   * clone a node in state, internal use: JSON.parse(JSON.stringify(node))\n   * let userList = store.copy('user.list');\n   */\n  copy(path) {\n    let arr = path ? path.split('.') : [];\n    let find = this.state;\n\n    while (typeof find === 'object' && arr.length) {\n      find = find[arr.shift()];\n    }\n\n    return JSON.parse(JSON.stringify(find));\n  }\n\n  /**\n   * [commit description]\n   * store.commit('main.user.add', {username: ''})\n   */\n  commit(mutation, payload, parent='') {\n    let arr = mutation.split('.', 2);\n    let location = parent ? parent + '.' + arr[0] : arr[0];\n\n    // log\n    if (this.debug && !parent) {\n      console.log(`data-hub log ~ store commit <${mutation}>`, payload);\n    }\n\n    // module\n    if (arr.length > 1) {\n      let moduleName = arr[0];\n      let module = this._modules[moduleName];\n\n      invariant(\n        module,\n        `data-hub error ~ store: module <${location}> is not defined!`\n      );\n\n      module.commit(arr[1], payload, location);\n\n      // let observer know\n      this._subject.next(this.getState());\n\n      return;\n    }\n\n    // mutation\n    invariant(\n      this._mutations[mutation],\n      `data-hub error ~ store: mutation <${location}> is not defined!`\n    )\n\n    let mutationFunc = this._mutations[mutation].bind(this);\n    mutationFunc(payload, this._state, this);\n\n    // let observer know\n    this._subject.next(this.getState());\n  }\n\n  // store is also a observer\n  next({mutation, payload}) {\n    this.commit(mutation, payload);\n  }\n\n  error() {\n    //\n  }\n\n  complete() {\n    //\n  }\n}\n","import {Observable, Subject} from './rxjs';\nimport invariant from './util/invariant';\n\nexport default class Hub {\n  // constructor\n  constructor(options={}) {\n    let beforeMiddlewares = options.beforeMiddlewares || [];\n    let afterMiddlewares = options.afterMiddlewares || [];\n\n    // Rx Refrence\n    this.Observable = Observable;\n    this.Subject = Subject;\n\n    // store pipes, middlewares\n    this._pipes = {};\n    this._middlewares = {\n      before: beforeMiddlewares,\n      after: afterMiddlewares,\n    };\n\n    // combinedMiddleware\n    this.combinedMiddleware = this.combinedMiddleware.bind(this);\n  }\n\n  // get pipe\n  pipe(name) {\n    invariant(\n      typeof this._pipes[name] === 'function',\n      `data-hub error ~ pipe <${name}> is undefined or not function!`\n    );\n    return this._pipes[name];\n  }\n\n  // add pipe\n  addPipe(name, converter) {\n    this._pipes[name] = (payload) => {\n      return Observable.of(payload)\n        .concatMap(this.combinedMiddleware('before', name))\n        .concatMap(converter)\n        .concatMap(this.combinedMiddleware('after', name));\n    }\n  }\n\n  // add pipes\n  addPipes(context, converters) {\n    Object.keys(converters).forEach(key => {\n      let converter = converters[key];\n      let pipeName = context + '.' + key;\n      this.addPipe(pipeName, converter);\n    });\n  }\n\n  // commine middlewares\n  combinedMiddleware(type, pipeName) {\n    return (payload) => {\n      let observable = Observable.of(payload);\n      this._middlewares[type].forEach(fn => {\n        observable = observable.map(payload => {\n          return {\n            payload,\n            pipeName,\n            type,\n          };\n        }).concatMap(fn);\n      });\n      return observable;\n    }\n  }\n\n  // add middleware\n  addMiddleware(type, middleware) {\n    this._middlewares[type].push(middleware);\n  }\n}\n","const VuePlugin = {};\n\nVuePlugin.install = function(Vue, options={}) {\n\n  let storeOptionKey = options.storeOptionKey || 'store';\n  let storeKey = options.storeKey || '$store';\n  let hubOptionKey = options.hubOptionKey || 'hub';\n  let hubKey = options.hubKey || '$hub';\n  let stateKey = options.stateKey || '$state';\n  let subscriptionsKey = options.subscriptionsKey || '$subs';\n\n  // mixin\n  Vue.mixin({\n\n    beforeCreate() {\n      const vm = this;\n      const options = vm.$options;\n      const store = options[storeOptionKey];\n      const hub = options[hubOptionKey];\n\n      // store injection\n      if (store) {\n        vm[storeKey] = typeof store === 'function' ? store() : store;\n        vm[stateKey] = ( new Vue({ data: vm[storeKey].state }) ).$data;\n      } else if (options.parent && options.parent[storeKey]) {\n        vm[storeKey] = options.parent[storeKey];\n        vm[stateKey] = options.parent[stateKey];\n      }\n\n      // hub injection\n      if (hub) {\n        vm[hubKey] = typeof hub === 'function' ? hub() : hub;\n      } else if (options.parent && options.parent[hubKey]) {\n        vm[hubKey] = options.parent[hubKey];\n      }\n\n      // subscriptions\n      vm[subscriptionsKey] = {};\n    },\n\n    methods: {\n      $unsubscribe(key) {\n        const vm = this;\n        const subscriptions = vm[subscriptionsKey];\n\n        try {\n          // unsubscribe one\n          if (key) {\n            if (\n              subscriptions[key]\n              && typeof subscriptions[key].unsubscribe === 'function'\n            ) {\n              subscriptions[key].unsubscribe();\n            }\n            return;\n          }\n\n          // unsubscribe all\n          Object.keys(subscriptions).forEach(key => {\n            let subscription = subscriptions[key];\n            if (subscription && typeof subscription.unsubscribe === 'function') {\n              subscription.unsubscribe();\n            }\n          });\n        } catch(e) {\n          console.log(e);\n        }\n      }\n    },\n\n    beforeDestroy() {\n      this.$unsubscribe();\n    }\n  });\n}\n\nexport default VuePlugin;\n","import {Observable} from '../rxjs';;\n\nexport default function logMiddleware({payload, pipeName, type}) {\n  let data = payload;\n  let typeMsg = {\n    before: 'in',\n    after: 'out'\n  }[type];\n\n  try {\n    let data = JSON.parse(JSON.stringify(payload));\n  } catch(e) {\n    //\n  }\n\n  console.log(`data-hub log ~ pipe ${typeMsg} <${pipeName}>:`, data);\n\n  return Observable.of(payload);\n}\n","export default function createRxHubComponent({\n  store,\n  hub,\n  storeKey = '$store',\n  hubKey = '$hub',\n  subscriptionsKey = '$subs',\n  unsubscribeKey = '$unsubscribe'\n}, React) {\n\n  class RxHubComponent extends React.Component {\n    constructor(props) {\n      super(props);\n\n      this[storeKey] = store;\n      this[hubKey] = hub;\n      this[subscriptionsKey] = {};\n\n      // unsubscribe\n      this[unsubscribeKey] = (key) => {\n        let subscriptions = this[subscriptionsKey];\n\n        try {\n          // remove one\n          if (key) {\n            if (\n              subscriptions[key]\n              && typeof subscriptions[key].unsubscribe === 'function'\n            ) {\n              subscriptions[key].unsubscribe();\n            }\n            return;\n          }\n\n          // remove all\n          Object.keys(subscriptions).forEach(key => {\n            let subscription = subscriptions[key];\n            if (typeof subscription.unsubscribe === 'function') {\n              subscription.unsubscribe();\n            }\n          });\n\n        } catch(e) {\n          console.error(e);\n        }\n      }\n    }\n\n    componentWillUnMount() {\n      this[unsubscribeKey]();\n    }\n  };\n\n  return RxHubComponent;\n}\n"],"names":["condition","format","a","b","c","d","e","f","error","undefined","Error","args","argIndex","replace","name","framesToPop","Store","options","_check","debug","_isRxHubStore","_subject","Subject","_state","initialState","_mutations","mutations","_modules","modules","keys","forEach","module","key","subscribe","state","this","moduleName","_this","getState","path","arr","split","find","length","shift","JSON","parse","stringify","mutation","payload","parent","location","log","commit","next","bind","Hub","beforeMiddlewares","afterMiddlewares","Observable","_pipes","_middlewares","combinedMiddleware","converter","of","concatMap","context","converters","pipeName","addPipe","type","observable","map","fn","middleware","push","VuePlugin","install","Vue","storeOptionKey","storeKey","hubOptionKey","hubKey","stateKey","subscriptionsKey","mixin","vm","$options","store","hub","data","$data","subscriptions","unsubscribe","subscription","$unsubscribe","typeMsg","React","unsubscribeKey","props","Component"],"mappings":"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"}